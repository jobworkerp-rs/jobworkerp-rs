syntax = "proto3";

package jobworkerp.function.service;

import "jobworkerp/data/common.proto";
import "jobworkerp/data/runner.proto";
import "jobworkerp/data/worker.proto";
import "jobworkerp/function/data/function.proto";

message FindFunctionRequest {
  bool exclude_runner = 1;
  bool exclude_worker = 2;
}

message FindFunctionSetRequest {
  // FunctionSet name
  string name = 1;
}

// Function search request by name
message FindFunctionByNameRequest {
  // Target name to search for (specify either runner name or worker name)
  oneof name {
    string runner_name = 1;
    string worker_name = 2;
  }
}

// Function search response (for consistency with existing services)
message OptionalFunctionSpecsResponse {
  // Search result (None if not found)
  optional jobworkerp.function.data.FunctionSpecs data = 1;
}
// runner parameters to create as a worker
message RunnerParameters {
  // Runner Settings in JSON format (from protobuf schema)
  string settings_json = 1;
  // Worker options (from protobuf schema)
  jobworkerp.function.data.WorkerOptions worker_options = 2;
}
message FunctionCallRequest {
  // Runner or Worker name to execute
  oneof name {
    string runner_name = 1;
    string worker_name = 2;
  }
  // Runner parameters (only for runner_name is set)
  optional RunnerParameters runner_parameters = 3;

  // Job Arguments in JSON format (with protobuf schema:
  // jobworkerp.data.RunnerData.job_args_proto)
  string args_json = 4;

  // Prevent from registering the same keys job in queue at the same time
  optional string uniq_key = 5;

  // Execution options
  optional jobworkerp.function.data.FunctionCallOptions options = 6;
}

// # Create Worker Request
// Create a Worker from any Runner with detailed configuration
message CreateWorkerRequest {
  // Runner identification (either name or id required)
  oneof runner {
    string runner_name = 1;    // Runner name (e.g., "COMMAND", "HTTP_REQUEST")
    jobworkerp.data.RunnerId runner_id = 2;
  }

  // Worker name (unique identifier)
  string name = 3;

  // Worker description (optional)
  optional string description = 4;

  // Runner settings in JSON format (from Runner's settings_schema)
  // Empty string or null if runner requires no settings
  optional string settings_json = 5;

  // Worker options (execution configuration)
  optional jobworkerp.function.data.WorkerOptions worker_options = 6;
}

// # Create Worker Response
message CreateWorkerResponse {
  // Created worker ID
  jobworkerp.data.WorkerId worker_id = 1;

  // Created worker name
  string worker_name = 2;
}

// # Create Workflow Request
// Create a REUSABLE_WORKFLOW Worker from workflow definition
message CreateWorkflowRequest {
  // Workflow definition source (either data or url required)
  oneof workflow_source {
    // Workflow definition as JSON or YAML string
    string workflow_data = 1;

    // URL to workflow definition file (JSON or YAML)
    string workflow_url = 2;
  }

  // Worker name (unique identifier)
  // If omitted, uses workflow's document.name field
  optional string name = 3;

  // Worker options (execution configuration)
  optional jobworkerp.function.data.WorkerOptions worker_options = 4;
}

// # Create Workflow Response
message CreateWorkflowResponse {
  // Created worker ID
  jobworkerp.data.WorkerId worker_id = 1;

  // Created worker name
  string worker_name = 2;

  // Workflow document name (from definition)
  optional string workflow_name = 3;
}

service FunctionService {
  rpc FindList(FindFunctionRequest)
      returns (stream jobworkerp.function.data.FunctionSpecs);
  rpc FindListBySet(FindFunctionSetRequest)
      returns (stream jobworkerp.function.data.FunctionSpecs);
  rpc Call(FunctionCallRequest)
      returns (stream jobworkerp.function.data.FunctionResult);

  // Function search by function using (FunctionId + optional using)
  rpc Find(jobworkerp.function.data.FunctionUsing) returns (OptionalFunctionSpecsResponse);

  // Function search by function name
  rpc FindByName(FindFunctionByNameRequest) returns (OptionalFunctionSpecsResponse);

  // Create a Worker from any Runner with detailed configuration
  rpc CreateWorker(CreateWorkerRequest) returns (CreateWorkerResponse);

  // Create a REUSABLE_WORKFLOW Worker from workflow definition
  rpc CreateWorkflow(CreateWorkflowRequest) returns (CreateWorkflowResponse);
}
